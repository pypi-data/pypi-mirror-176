<!DOCTYPE html>
<html>
    <head>
        <title>Visual Sponge</title>
        <meta charset="UTF-8">
        <script src="/static/3dmol.js" async></script>
        <link rel="stylesheet" href="/static/codemirror.css">
        <script src="/static/codemirror.js"></script>
        <script src="/static/myCodeMirror.js"></script>
        <link rel="stylesheet" href="/static/navi.css"/>
    </head>
    <body>
        <div class="nav">
            <ul class="navbar">
                <li class="" ><a>{{"file" | localization}}</a></li>
                <li class="" ><a>{{"display" | localization}}</a>
                  <ul>
                    <li><a>{{"placeholder" | localization}}</a></li>
                    <li><a>{{"placeholder" | localization}}</a></li>
                  </ul>
                </li>
                <li class="" ><a>{{"settings" | localization}}</a></li>
                <li class="" ><a>{{"help" | localization}}</a></li>
                <li class="" ><a>{{"contact us" | localization}}</a></li>
            </ul>
        </div>
        <div class="main">
            <div class="box1">
                <textarea id="show_code">{{ "Welcome to Use Visual Sponge!" | localization}}</textarea>
                <div id="input_box">
                <p class="hint">cmd ></p>
                <textarea id="write_code"></textarea>
                </div>
            </div>
            <div class="box2">
                <div class="box2_frame" style="height:100px">
                <p class="hint">{{"Frame" | localization}}:
                <input type="number" id="curframe" min="0" max="0" value="0" oninput="frame_change(value)" style="width:20%">
                /
                <input type="number" id="maxframe" value="0" disabled="disabled" style="width:20%"></p>
                <input type="range" value="0" min="0" max="0" id="curframeRange" oninput="frame_change(value)" style="width:80%">
                </div>
                <div class="box2_frame" style="height:calc(100% - 140px);overflow: auto;">
                <p class="hint">{{"Model" | localization}}:</p>
                <div id="models">
                </div>
                </div>
            </div>
            <div id="3dmol_viewer" class="box3 viewer_3Dmoljs" data-backgroundcolor='0x000000'></div>
        </div>
    </body>
    <script type="text/javascript">
    function refresh_models()
    {
        $('#models').children().remove();
        let v = $3Dmol.viewers["3dmol_viewer"];
        let ms = v.addModels();
        for (let i = 0; i < ms.length; i++)
        {
            if (ms[i])
            {
                let j = ms[i].getID();
                $('#models').append("<div class='model_present' id='model_div_" + j + "'></div>");
                let that = $('#model_div_' + j)
                that.append("<p class='hint'>{{ "Model" | localization }} " + j + ": " + ms[i].name + "</p>");
                stat = ms[i].getInternalState();
                that.append("<p class='hint'>#{{ "Atom" | localization }}: " + stat.atoms.length + " | #{{ "Frame" | localization }}: " + stat.frames.length + "</p>");
                that.append("<div class='two-grid-div' id='two-grid-div-" + j + "'></div>");
                that = $('#two-grid-div-' + j);
                let temp = "btn-on-" + j;
                that.append('<p class="hint">{{ "Show" | localization}}:</p>');
                that.append('<p class="btn-on hint" id="' + temp + '" onclick="on_off(' + j + ', \'ON\')"><span class="btn-on-circle" id="' + temp + '-circle"></span><span class="btn-on-text" id="' + temp + '-text">ON</span></p>')
            }
        }
        $('#maxframe').val(v.getNumFrames() - 1);
        $('#curframe').val(v.getFrame());
        $('#curframe').attr("max",v.getNumFrames() - 1);
        $('#curframeRange').attr("max",v.getNumFrames() - 1);
    }
    function vs_initialize()
    {
        vs_backend_command("VERSION()", false);
        v = $3Dmol.viewers["3dmol_viewer"];
        sm = v.ui.initiateUI();
    }
    function vs_finalize()
    {
        navigator.sendBeacon('exit', {});
    }
    function vs_frontend_command(command, arguments)
    {
        try
        {
            let m;
            switch (command)
            {
                case "MODEL":
                    m = v.addModel();
                    m.addAtoms(arguments.atoms);
                    if (arguments.crds)
                    {
                        m.setCoordinates(arguments.crds, "array");
                    }
                    m.name = arguments.name;
                    m.setStyle({sphere:{}});
                    v.render();
                    refresh_models();
                    break;
                case "TRAJ":
                    m = v.getModel(arguments.mid);
                    m.setCoordinates(arguments.crds, "array", arguments.append);
                    refresh_models();
                    break;
                default:
                    editor.setValue(editor.getValue() + "\nFrontendError: "+ "CommandNotFoundError: " + command + "is not a valid command");
                    editor.scrollTo(0, editor.getScrollInfo()["height"]);
            }
        }
        catch (error)
        {
            editor.setValue(editor.getValue() + "\nFrontendError: "+ error);
            editor.scrollTo(0, editor.getScrollInfo()["height"]);
        }
    }
    function vs_backend_command(command, show_command=true) 
    {
        if (command && show_command)
        {
            editor.setValue(editor.getValue() + "\ncmd> "+ command);
            editor.scrollTo(0, editor.getScrollInfo()["height"]);
        }
        if (command)
        {
            $.post('cmd',
                   {value: command},
                    function(result) {
                        editor.setValue(editor.getValue() + "\n"+ result["text"]);
                        if (result["cmd"])
                        {
                            for (let key in result["cmd"])
                            {
                                vs_frontend_command(key, result["cmd"][key]);
                            }
                        }
                        editor.scrollTo(0, editor.getScrollInfo()["height"]);
                        editor2_flag = true;
                    }
            );
        }
    }
    var editor = CodeMirror.fromTextArea(document.getElementById("show_code"),
    {
        lineNumbers: true,
        lineWrapping: true,
        mode: "text/x-python",
        readOnly: 'true',
        firstLineNumber: 0,
        scrollbarStyle: "native",
    });
    editor.setSize('auto','130px');
    var editor2 = CodeMirror.fromTextArea(document.getElementById("write_code"),
    {
        mode: "text/x-python",
        scrollbarStyle: "null",
    });
    editor2.setSize('auto','25px');
    var editor2_flag = true;
    editor2.setOption("extraKeys",
    {
        Enter: function(cm)
        {
            if (editor2_flag)
            {
                vs_backend_command(cm.getValue());
                if (cm.getValue())
                {
                    cm.setValue("");
                    editor2_flag = false;
                }
            }
        }
    });
    var v;
    var sm;
    setTimeout(vs_initialize, 100);
    window.onbeforeunload = function () {return "{{ 'Really quit?' | localization }}"}
    window.onunload = vs_finalize;
    </script>
    <script>
    function on_off(i, type)
    {
        let temp = "btn-on-" + i;
        var btn = document.getElementById(temp);
        var circle = document.getElementById(temp + "-circle");
        var text = document.getElementById(temp + "-text");
        if (type == "ON")
        {
            btn.style= "background-color: #ccc;";
            circle.style="left: 40px;background-color: #888;box-shadow: 0 0 10px #888;";
            text.style="right: 30px;color: #888;";
            text.innerText="OFF";
            btn.setAttribute("onclick", "on_off(" + i + ", 'OFF')");
        }
        else
        {
            btn.style= "";
            circle.style="";
            text.style="";
            text.innerText="ON";
            btn.setAttribute("onclick", "on_off(" + i + ", 'ON')");
        }
    }
    function frame_change(value)
    {
        $('#curframe').val(value);
        $('#curframeRange').val(value);
        v.setFrame(value);
        v.render();
    }
    </script>
</html>